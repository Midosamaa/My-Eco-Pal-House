<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consommations</title>
    <link rel="stylesheet" href="../../static/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>Suivi des Consommations</h1>
        <nav class="nav">
            <a href="{{ url_for('home') }}">Accueil</a>
            <a href="{{ url_for('consommation') }}" class="active">Consommation</a>
            <a href="{{ url_for('capteurs') }}">Capteurs/Actionneurs</a>
            <a href="{{ url_for('economies') }}">Économies</a>
            <a href="{{ url_for('configuration') }}">Configuration</a>
        </nav>
        <div class="account-menu">
            <img src="../../static/images/account-icon2.png" alt="Compte" class="account-icon">
            <ul class="dropdown-menu">
                <li><a href="{{ url_for('change_password') }}">Changer de mot de passe</a></li>
                <li><a href="{{ url_for('logout') }}">Se déconnecter</a></li>
            </ul>
        </div>
    </header>

    <div class="container">
        <section class="hero">
            <h2>Consommations récentes</h2>
            <p>Voici un aperçu de vos consommations récentes.</p>
        </section>

        <!-- Graphique des consommations -->
        <section class="charts">
            <h3>Consommation globale</h3>
            <canvas id="consommationChart"></canvas>
        </section>

        <!-- Filtre des consommations -->
        <section class="filters">
            <h3>Filtrer les consommations</h3>
            <select id="consumption-type" class="filter">
                <option value="all">Toutes les consommations</option>
                <option value="electricity">Électricité</option>
                <option value="water">Eau</option>
                <option value="gas">Gaz</option>
            </select>
            
            <select id="time-period" class="filter">
                <option value="month">Ce mois-ci</option>
                <option value="year">Cette année</option>
                <option value="all-time">Depuis la création</option>
            </select>
            
            <button id="apply-filters">Appliquer</button>
        </section>

        <section class="consumption-tips">
            <h3>Conseils pour réduire la consommation</h3>
            <ul>
                <li>Éteindre les appareils inutilisés pour économiser de l'énergie.</li>
                <li>Optimiser l'utilisation de l'eau avec des équipements économes.</li>
                <li>Suivre les conseils de vos capteurs pour réduire la consommation.</li>
            </ul>
        </section>

        <section class="consumption-table">
            <h3>Tableau des consommations</h3>
            <table>
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Mois</th>
                        <th>Consommation</th>
                    </tr>
                </thead>
                <tbody>
                    {% for type_conso, data in consommations.items() %}
                        {% for entry in data %}
                            <tr>
                                <td>{{ type_conso | capitalize }}</td>
                                <td>{{ entry.date }}</td>
                                <td>{{ entry.conso }} kWh</td>
                            </tr>
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </section>
    </div>

    <footer class="footer">
        <p>© 2024 My Eco Pal House.</p>
    </footer>

    <!-- Scripts -->
    <script>
        // Utiliser directement la variable 'consommations' envoyée par Flask
        // Assurez-vous que la variable consommations est bien envoyée et accessible.
        var consommations =   "{{ consommations }}";
        consommations =   JSON.parse(consommations)
        console.log(consommations);
        // Formatage des données pour l'affichage
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
        // Données de consommation par type
        const electricityData = consommations.electricity.map(item => item.conso);
        const waterData = consommations.water.map(item => item.conso);
        const gasData = consommations.gas.map(item => item.conso);
    
        // Initialisation du graphique
        const chartData = {
            labels: months,
            datasets: [{
                label: 'Consommation Électricité',
                data: electricityData,
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }, {
                label: 'Consommation Eau',
                data: waterData,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }, {
                label: 'Consommation Gaz',
                data: gasData,
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 1
            }]
        };
    
        const ctx = document.getElementById('consommationChart').getContext('2d');
        const consommationChart = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                scales: {
                    x: { beginAtZero: true },
                    y: { beginAtZero: true }
                }
            }
        });
    
        // Fonction pour appliquer les filtres
        document.getElementById('apply-filters').addEventListener('click', () => {
            const selectedType = document.getElementById('consumption-type').value;
            const selectedPeriod = document.getElementById('time-period').value;
    
            let filteredData = {};
    
            // Filtrage des données selon le type de consommation
            if (selectedType === 'all') {
                filteredData = consommations;
            } else {
                filteredData = { [selectedType]: consommations[selectedType] };
            }
    
            // Appliquer un filtrage selon la période (ce mois, cette année, etc.)
            if (selectedPeriod === 'month') {
                // Exemple simple: filtrer pour le mois actuel (tu peux ajuster cela)
                const currentMonth = new Date().getMonth();
                for (let type in filteredData) {
                    filteredData[type] = filteredData[type].filter(item => new Date(item.date).getMonth() === currentMonth);
                }
            }
    
            // Mise à jour du graphique avec les données filtrées
            updateChart(filteredData);
        });
    
        // Fonction pour mettre à jour le graphique avec les données filtrées
        function updateChart(filteredData) {
            const updatedData = {
                labels: months,
                datasets: []
            };
    
            if (filteredData.electricity) {
                updatedData.datasets.push({
                    label: 'Consommation Électricité',
                    data: filteredData.electricity.map(item => item.conso),
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                });
            }
            if (filteredData.water) {
                updatedData.datasets.push({
                    label: 'Consommation Eau',
                    data: filteredData.water.map(item => item.conso),
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                });
            }
            if (filteredData.gas) {
                updatedData.datasets.push({
                    label: 'Consommation Gaz',
                    data: filteredData.gas.map(item => item.conso),
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                });
            }
    
            consommationChart.data = updatedData;
            consommationChart.update();
        }
    </script>   
</body>
</html>
