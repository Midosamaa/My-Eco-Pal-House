<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consommations</title>
    <link rel="stylesheet" href="../../static/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>Suivi des Consommations</h1>
        <nav class="nav">
            <a href="{{ url_for('home') }}">Accueil</a>
            <a href="{{ url_for('consommation') }}" class="active">Consommation</a>
            <a href="{{ url_for('capteurs') }}">Capteurs/Actionneurs</a>
            <a href="{{ url_for('measures') }}" >Mesures</a>
            <a href="{{ url_for('economies') }}">Économies</a>
            <a href="{{ url_for('configuration') }}">Configuration</a>
        </nav>
        <div class="account-menu">
            <img src="../../static/images/account-icon2.png" alt="Compte" class="account-icon">
            <ul class="dropdown-menu">
                <li><a href="{{ url_for('change_password') }}">Changer de mot de passe</a></li>
                <li><a href="{{ url_for('logout') }}">Se déconnecter</a></li>
            </ul>
        </div>
    </header>

    <div class="container">
        <section class="hero">
            <h2>Consommations récentes</h2>
            <p>Voici un aperçu de vos consommations récentes.</p>
        </section>

        <!-- Graphique des consommations -->
        <h3>Consommation globale</h3>
        <section class="charts charts-row">
            
            <div id="pieChartContainer">
                <canvas id="consommationPieChart"></canvas>
            </div>
                    <!-- Graphiques détaillés -->
            <section class="charts-container hidden" id="charts-container">
                <canvas id="lineChart"></canvas>
            </section>
        </section>



        <!-- Tableau des consommations -->
        <section class="consumption-table hidden" id="consumptionTable">
            <h3>Tableau détaillé des consommations</h3>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Consommation</th>
                        <th>Montant (€)</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Les lignes seront ajoutées dynamiquement -->
                </tbody>
            </table>
        </section>

        <section class="consumption-tips">
            <h3>Conseils pour réduire la consommation</h3>
            <ul>
                <li>Éteindre les appareils inutilisés pour économiser de l'énergie.</li>
                <li>Optimiser l'utilisation de l'eau avec des équipements économes.</li>
                <li>Suivre les conseils de vos capteurs pour réduire la consommation.</li>
            </ul>
        </section>

        <footer class="footer">
            <p>© 2024 My Eco Pal House.</p>
        </footer>

        <script>
            // Define units for each type of consumption
            const units = {
                electricity: 'kWh',
                water: 'm³',
                gas: 'm³',
                internet: 'GB'
            };
            
            // Fetch consumption data
            var consommations = {{ consommations | tojson }};
            console.log(consommations);
            
            // Calculate total consumptions for each type
            var totalElectricity = consommations.electricity.reduce((sum, item) => sum + item.consommation, 0);
            var totalWater = consommations.water.reduce((sum, item) => sum + item.consommation, 0);
            var totalGas = consommations.gas.reduce((sum, item) => sum + item.consommation, 0);
            var totalInternet = consommations.internet.reduce((sum, item) => sum + item.consommation, 0);
            
            // Prepare data for the pie chart
            var consommationData = {
                labels: ['Électricité', 'Eau', 'Gaz', 'Internet'],
                datasets: [{
                    data: [totalElectricity, totalWater, totalGas, totalInternet],
                    backgroundColor: ['#4bc0c0', '#36a2eb', '#ff6384', '#ffcc00'],
                    hoverBackgroundColor: ['#4bc0c0', '#36a2eb', '#ff6384', '#ffcc00']
                }]
            };
            
            // Create the pie chart
            var consommationPieChart;
            window.onload = function () {
                var ctx = document.getElementById('consommationPieChart').getContext('2d');
                consommationPieChart = new Chart(ctx, {
                    type: 'pie',
                    data: consommationData,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (tooltipItem) {
                                        const type = tooltipItem.label.toLowerCase();
                                        const unit = units[type];
                                        return `${tooltipItem.label}: ${tooltipItem.raw.toFixed(2)} ${unit}`;
                                    }
                                }
                            }
                        },
                        onClick: (event, activeElements) => {
                            if (activeElements.length > 0) {
                                const index = activeElements[0].index;
                                const consommationTypeMap = ['electricity', 'water', 'gas', 'internet'];
                                const consommationType = consommationTypeMap[index];
                                showConsumptionDetails(consommationType);
                            }
                        }
                    }
                });
            };
            
            // Show detailed consumption data
            function showConsumptionDetails(consommationType) {
                console.log("Type cliqué :", consommationType);
            
                // Show the table and detailed chart
                document.getElementById('charts-container').classList.remove('hidden');
                document.getElementById('consumptionTable').classList.remove('hidden');
            
                // Reset the table
                var tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = '';
                const unit = units[consommationType]; // Get the unit for the selected type
            
                consommations[consommationType].forEach(function (entry) {
                    var row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${entry.date}</td>
                        <td>${entry.consommation} ${unit}</td>
                        <td>${entry.montant.toFixed(2)} €</td>
                    `;
                    tableBody.appendChild(row);
                });
            
                // Update the detailed chart
                showLineChart(consommationType, unit);
            }
            
            var lineChartInstance; // Store the line chart instance
            
            // Show the line chart for the selected consumption type
            function showLineChart(consommationType, unit) {
                var ctx = document.getElementById('lineChart').getContext('2d');
                var labels = [];
                var data = [];
            
                // Prepare data for the chart
                consommations[consommationType].forEach(function (entry) {
                    labels.push(entry.date);
                    data.push(entry.consommation);
                });
            
                // Destroy the previous chart instance if it exists
                if (lineChartInstance) {
                    lineChartInstance.destroy();
                }
            
                // Create a new chart
                lineChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Consommation ${consommationType} (${unit}) sur les 30 derniers jours`,
                            data: data,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        }
                    }
                });
            }
            </script>
            
    </div>
</body>
</html>
