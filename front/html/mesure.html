<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesures</title>
    <link rel="stylesheet" href="../../static/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1>Logement Éco-Responsable</h1>
            <nav class="nav">
                <a href="{{ url_for('home') }}">Accueil</a>
                <a href="{{ url_for('consommation') }}">Consommation</a>
                <a href="{{ url_for('capteurs') }}">Capteurs/Actionneurs</a>
                <a href="{{ url_for('measures') }}" class="active">Mesures</a>
                <a href="{{ url_for('economies') }}">Économies</a>
                <a href="{{ url_for('configuration') }}">Configuration</a>
            </nav>
            <div class="account-menu">
                <img src="../../static/images/account-icon2.png" alt="Compte" class="account-icon">
                <ul class="dropdown-menu">
                    <li><a href="{{ url_for('change_password') }}">Changer de mot de passe</a></li>
                    <li><a href="{{ url_for('logout') }}">Se déconnecter</a></li>
                </ul>
            </div>
        </div>
    </header>

    <section class="hero">
        <h2>Historique des Mesures</h2>
        <p>Visualisez les dernières mesures collectées par vos capteurs.</p>
    </section>

    <!-- Section: Table of Measures -->
    <section class="measures">
        <h3>Dernières Mesures</h3>
        <div id="measuresTableContainer">
            <table id="measuresTable">
                <thead>
                    <tr>
                        <th>Capteur</th>
                        <th>Température (°C)</th>
                        <th>Humidité (%)</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <!-- Section: Graphs -->
    <section class="graphs">
        <h3>Graphiques des Dernières Mesures</h3>
        <div>
            <canvas id="temperatureChartCanvas"></canvas> <!-- Temperature graph -->
        </div>
        <div>
            <canvas id="humidityChartCanvas"></canvas> <!-- Humidity graph -->
        </div>
    </section>

    <script>
let measuresData = []; // Declare measuresData globally
let temperatureChartInstance = null; // Store the temperature chart instance
let humidityChartInstance = null; // Store the humidity chart instance
const tableBody = document.querySelector('#measuresTable tbody'); // Initialize tableBody

// Initialize the canvas elements for the graphs
const temperatureChartCanvas = document.getElementById('temperatureChartCanvas');
const humidityChartCanvas = document.getElementById('humidityChartCanvas');

// Flag to track the first load of the graphs
let isFirstLoad = true;

// Function to load the last 10 DHT11 measures
async function loadDHT11Measures() {
    try {
        const response = await fetch('/api/dht11_measures');
        if (!response.ok) {
            throw new Error(`Error fetching measures: ${response.statusText}`);
        }
        const data = await response.json();

        // Check if the data is different to avoid redundant table updates
        if (JSON.stringify(data) !== JSON.stringify(measuresData)) {
            measuresData = data;
            updateTable();
            updateGraphs(); // Update both table and graphs
        }
    } catch (error) {
        console.error('Error loading DHT11 measures:', error);
    }
}

// Function to update the table with the fetched measures
function updateTable() {
    tableBody.innerHTML = ''; // Clear the table body before populating
    measuresData.forEach(measure => {
        const tr = document.createElement('tr');

        // Ensure temperature and humidity are valid numbers
        const temperature = isNaN(parseFloat(measure.temperature)) ? 'Non disponible' : parseFloat(measure.temperature).toFixed(2);
        const humidity = isNaN(parseFloat(measure.humidity)) ? 'Non disponible' : parseFloat(measure.humidity).toFixed(2);

        tr.innerHTML = `
            <td>${measure.capt_act_ref}</td>
            <td>${temperature}</td>
            <td>${humidity}</td>
            <td>${measure.date_insertion}</td>
        `;
        tableBody.appendChild(tr);
    });
}

// Function to update the graphs
function updateGraphs() {
    const labels = measuresData.map(measure => measure.date_insertion); // Dates for X-axis
    const temperatures = measuresData.map(measure => measure.temperature); // Temperature values
    const humidities = measuresData.map(measure => measure.humidity); // Humidity values

    // Destroy the existing temperature chart if it exists
    if (temperatureChartInstance) {
        temperatureChartInstance.destroy();
    }

    // Create the new temperature chart
    temperatureChartInstance = new Chart(temperatureChartCanvas, {
        type: 'line', // Line chart
        data: {
            labels: labels,
            datasets: [{
                label: 'Température (°C)',
                data: temperatures,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            animation: isFirstLoad ? { // Enable animation only on the first load
                duration: 1000, // Animation duration (in ms)
                easing: 'easeOutBounce'
            } : false, // Disable animation after the first load
            scales: {
                x: {
                    reverse: true, // Reverse the time axis (right to left)
                    ticks: {
                        maxRotation: 90,
                        minRotation: 45
                    }
                }
            }
        }
    });

    // Destroy the existing humidity chart if it exists
    if (humidityChartInstance) {
        humidityChartInstance.destroy();
    }

    // Create the new humidity chart
    humidityChartInstance = new Chart(humidityChartCanvas, {
        type: 'line', // Line chart
        data: {
            labels: labels,
            datasets: [{
                label: 'Humidité (%)',
                data: humidities,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            animation: isFirstLoad ? { // Enable animation only on the first load
                duration: 1000, // Animation duration (in ms)
                easing: 'easeOutBounce'
            } : false, // Disable animation after the first load
            scales: {
                x: {
                    reverse: true, // Reverse the time axis (right to left)
                    ticks: {
                        maxRotation: 90,
                        minRotation: 45
                    }
                }
            }
        }
    });

    // After the first load, set the flag to false
    if (isFirstLoad) {
        isFirstLoad = false;
    }
}

// Initialize the loading of DHT11 measures when the page loads
document.addEventListener('DOMContentLoaded', () => {
    loadDHT11Measures(); // Load on page load
    setInterval(loadDHT11Measures, 2000); // Poll every 2 seconds
});
    </script>
</body>
</html>
